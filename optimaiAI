
#!/bin/bash

# OptimAI-CLI-Node Automated Installation Script
# Based on https://github.com/OptimaiNetwork/OptimAI-CLI-Node

# Check if script is run with arguments
if [ $# -lt 2 ]; then
    echo "Usage: $0 <email> <password>"
    echo "Example: $0 user@example.com mypassword123"
    exit 1
fi

# Store email and password from arguments
EMAIL=$1
PASSWORD=$2

echo "===== OptimAI CLI Node Installation Script ====="
echo "This script will install Docker, set up OptimAI-CLI-Node, and configure auto-start."
echo "Installation will use email: $EMAIL"
echo

# Update system packages
echo "Updating system packages..."
sudo apt-get update
sudo apt-get upgrade -y

# Install required packages
echo "Installing required packages..."
sudo apt-get install -y curl wget gnupg lsb-release ca-certificates apt-transport-https

# Check if Docker is already installed
if command -v docker &> /dev/null; then
    echo "Docker is already installed."
else
    echo "Installing Docker..."
    
    # Add Docker's official GPG key
    sudo mkdir -p /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    
    # Add Docker repository
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    
    # Update package index with Docker repository
    sudo apt-get update
    
    # Install Docker
    sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
    
    # Add current user to Docker group
    sudo usermod -aG docker $USER
    
    echo "Docker installed successfully."
fi

# Set Docker to start on boot
echo "Configuring Docker to start on boot..."
sudo systemctl enable docker
sudo systemctl start docker

# Create OptimAI directory
echo "Setting up OptimAI CLI Node..."
mkdir -p ~/optimai-cli-node
cd ~/optimai-cli-node

# Download and set up OptimAI CLI Node
echo "Pulling OptimAI CLI Node Docker image..."
sudo docker pull optimainetwork/optimai-cli-node:latest

# Create configuration file
echo "Creating configuration file..."
cat > ~/.optimai-config.json << EOF
{
  "email": "$EMAIL",
  "password": "$PASSWORD",
  "auto_start": true,
  "data_dir": "$HOME/optimai-cli-node/data"
}
EOF

# Create data directory
mkdir -p ~/optimai-cli-node/data

# Create Docker run script
echo "Creating startup script..."
cat > ~/optimai-cli-node/start-node.sh << EOF
#!/bin/bash
sudo docker run -d \\
  --name optimai-cli-node \\
  --restart always \\
  -v ~/.optimai-config.json:/app/config.json \\
  -v $HOME/optimai-cli-node/data:/app/data \\
  optimainetwork/optimai-cli-node:latest
EOF

chmod +x ~/optimai-cli-node/start-node.sh

# Create systemd service file for auto-start
echo "Creating systemd service for auto-start..."
cat > /tmp/optimai-node.service << EOF
[Unit]
Description=OptimAI CLI Node
After=docker.service
Requires=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=$HOME/optimai-cli-node
ExecStart=$HOME/optimai-cli-node/start-node.sh
ExecStop=sudo docker stop optimai-cli-node
ExecStopPost=sudo docker rm optimai-cli-node
User=$USER

[Install]
WantedBy=multi-user.target
EOF

sudo mv /tmp/optimai-node.service /etc/systemd/system/

# Enable and start the service
echo "Enabling and starting OptimAI CLI Node service..."
sudo systemctl daemon-reload
sudo systemctl enable optimai-node.service
sudo systemctl start optimai-node.service

# Create a convenient status check script
cat > ~/optimai-cli-node/check-status.sh << EOF
#!/bin/bash
sudo docker ps -a | grep optimai-cli-node
sudo docker logs optimai-cli-node
EOF

chmod +x ~/optimai-cli-node/check-status.sh

echo
echo "===== OptimAI CLI Node Installation Complete ====="
echo "The OptimAI CLI Node has been installed and configured to start automatically."
echo
echo "You can manage your node with the following commands:"
echo "- Check node status: ~/optimai-cli-node/check-status.sh"
echo "- Restart node: sudo systemctl restart optimai-node.service"
echo "- Stop node: sudo systemctl stop optimai-node.service"
echo "- Start node: sudo systemctl start optimai-node.service"
echo
echo "Your configuration is stored in ~/.optimai-config.json"
echo "Your node data is stored in ~/optimai-cli-node/data"
echo
echo "Note: You may need to log out and log back in for Docker group membership to take effect."
